name: push_to_cloud

on:
  push:
    branches: ['master']


jobs:
  push_to_cloud:
    runs-on: ubuntu-latest
    steps:
      - name: push
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{vars.HETZNER_HOST_PAID_INSTANCE}} #$ for SSH, don't include port unless not using :22 . Example: 132.84.129.77.
          username: ${{secrets.HETZNER_USER}}
          key: ${{secrets.HETZNER_SSH_PRIVATE_KEY}}
          passphrase: ${{ secrets.EC2_SSH_PRIVATE_KEY_PASSPHRASE }} #$ Only if required.

          script: |
            UNIQUE_APP_NAME="${{ vars.UNIQUE_APP_NAME }}"  #! UNIQUE_APP_NAME must be all lowercase and without underscores for Docker to accept it.
            #! UNIQUE_APP_NAME must be set per-repository
            #! If you are using Docker COMPOSE,  you don't need a unique app name for the image name. However, you still need a unique directory name.
            REPO_PATH="${{github.repository}}"

            cd ~/vsCodeMain
            [ -d "$UNIQUE_APP_NAME/.git" ] || git clone git@github.com:$REPO_PATH.git  "$UNIQUE_APP_NAME" #! YOU NEED TO USE A KEY THAT HAS NO PASSPHRASE
            cd "$UNIQUE_APP_NAME"
            git fetch
            git merge origin/master

            rm ./config/shared.env || true #! Important to remove


            #* CURRENTLY USING HETZNER SETTINGS
            echo "OBJECT_STORAGE_BUCKET_REGION=${{secrets.HETZNER_OBJECT_STORAGE_BUCKET_REGION}}" >> ./config/shared.env
            echo "OBJECT_STORAGE_BUCKET_NAME=${{secrets.HETZNER_OBJECT_STORAGE_BUCKET_NAME}}" >> ./config/shared.env
            echo "OBJECT_STORAGE_ACCESS_KEY=${{secrets.HETZNER_OBJECT_STORAGE_ACCESS_KEY}}" >> ./config/shared.env
            echo "OBJECT_STORAGE_SECRET_KEY=${{secrets.HETZNER_OBJECT_STORAGE_SECRET_KEY}}" >> ./config/shared.env
            echo "OBJECT_STORAGE_ENDPOINT=${{secrets.HETZNER_OBJECT_STORAGE_SECRET_KEY}}" >> ./config/shared.env #! Only required by Hetzner

            #OAUTH (Google)
            echo "CLIENT_ID_GOOGLE=${{secrets.CLIENT_ID_GOOGLE}}" >> ./config/shared.env
            echo "CLIENT_SECRET_GOOGLE=${{secrets.CLIENT_SECRET_GOOGLE}}" >> ./config/shared.env
            echo "NEXTAUTH_SECRET=${{secrets.NEXTAUTH_SECRET}}" >> ./config/shared.env #* Read readme -> Oauth

            echo "STRIPE_SECRET_KEY=${{secrets.STRIPE_SECRET_KEY}}" >> ./config/shared.env
            echo "STRIPE_SIGNING_SECRET=${{secrets.STRIPE_SIGNING_SECRET}}" >> ./config/shared.env

            echo "BREVO_API_KEY=${{secrets.STRIPE_SIGNING_SECRET}}" >> ./config/shared.env
            echo "ADMIN_EMAIL=${{vars.ADMIN_EMAIL}}" >> ./config/shared.env


            #* ================================= Docker commands =============================================
            docker rm -f "$UNIQUE_APP_NAME"
            docker build -t "$UNIQUE_APP_NAME" .
            docker run --env-file ./config/shared.env  --name "$UNIQUE_APP_NAME"  -p 3009:3000 -it -d --rm "$UNIQUE_APP_NAME"




